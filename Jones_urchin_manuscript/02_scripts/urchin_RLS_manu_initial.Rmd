---
title: "urchin_RLS_manu"
author: "Alec Jones"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
   toc: true
---

   <script src="hideOutput.js"></script> 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(sdmTMB)
```

For this project I am continuing on from the work I did for my Honours and pivoting away from just looking at the red turban snails and red sea urchins within Barkley Sound based on environmental drivers and protection from fishing status. I will be looking at only protection from fishing status and looking at urchins in general, fish, and kelp communities to get a more complete picture of the effectiveness or lack thereof of protected areas within Barkley Sound.

# Loading in the data

For this analysis I will be using four years of data from the RLS surveys instead of only 1. I will need to download the RLS data from the website and combine the three files together (mobile fish, cryptobenthic fish, macroinverts)

```{r Downloading the macroinvert data, echo=FALSE}
#Reading in the macroinvert data from the csv downloaded from the RLS website

macroinvert_data_raw <- read_csv(here("./01_raw_data/cleaned_Global_mobile_macroinvertebrate_abundance.csv"))
```

```{r Loading in the cryptobenthic fish data, echo=FALSE}
cryptobenthic_fish_data_raw <- read_csv(here("./01_raw_data/cleaned_Global_cryptobenthic_fish_abundance.csv"))
```

```{r Loading in the mobile fish data, echo=FALSE}
mobile_fish_data_raw <- read_csv(here("./01_raw_data/cleaned_Global_reef_fish_abundance_and_biomass.csv"))
```

## Testing the data

```{r Testing to see if the fish data needs to be combined or not}
#test_mobile <- mobile_fish_data_raw%>%
 # filter(site_code == "BMSC1" & reporting_name == "Rhinogobiops nicholsii" 
    #     & survey_date == "2023-05-15")

#test_cryptic <- cryptobenthic_fish_data_raw%>%
#  filter(site_code == "BMSC1" & reporting_name == "Rhinogobiops nicholsii" 
   #      & survey_date == "2023-05-15")
```

After checking it appears that the cryptic fish and mobile fish csv files need to be combined and then the counts match up with the Excel sheet supplied.

## Combining the three dfs into one overall and cleaning up for use

```{r Combining the three DFs}
overall_rls_data_raw <- rbind(cryptobenthic_fish_data_raw, macroinvert_data_raw,
                              mobile_fish_data_raw)
```


```{r Correcting the lat and long to be correct}
overall_rls_data_raw_lat_long <- overall_rls_data_raw%>%
 mutate(latitude = if_else(site_code == "BMSC1", 48.82894897, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC1", -125.1975708, longitude))%>%
  
   mutate(latitude = if_else(site_code == "BMSC2", 48.85039902, latitude))%>%
   mutate(longitude = if_else(site_code == "BMSC2", -125.1987686, longitude))%>%
  
 mutate(latitude = if_else(site_code == "BMSC3", 48.85558319, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC3", -125.1837997, longitude))%>%
  
   mutate(latitude = if_else(site_code == "BMSC4", 48.81511688, latitude))%>%
   mutate(longitude = if_else(site_code == "BMSC4", -125.1753311, longitude))%>%
  
 mutate(latitude = if_else(site_code == "BMSC5", 48.82733154, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC5", -125.1966019, longitude))%>%
  
   mutate(latitude = if_else(site_code == "BMSC6", 48.95023346, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC6", -125.1555481, longitude))%>%
  
  mutate(latitude = if_else(site_code == "BMSC7", 48.954644, latitude))%>%
  mutate(longitude = if_else(site_code == "BMSC7", -125.153993, longitude))%>%
  
    mutate(latitude = if_else(site_code == "BMSC8", 48.95508194, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC8", -125.1533737, longitude))%>%

    mutate(latitude = if_else(site_code == "BMSC9", 48.83478928, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC9", -125.1470261, longitude))%>%
  
 mutate(latitude = if_else(site_code == "BMSC10", 48.87051773, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC10", -125.160347, longitude))%>%
  
 mutate(latitude = if_else(site_code == "BMSC11", 48.85746765, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC11", -125.1582336, longitude))%>%
  
  mutate(latitude = if_else(site_code == "BMSC12", 48.858284, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC12", -125.1609192, longitude))%>%
  
mutate(latitude = if_else(site_code == "BMSC13", 48.8650322, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC13", -125.3137207, longitude))%>%
  
mutate(latitude = if_else(site_code == "BMSC14", 48.87908173, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC14", -125.2974014, longitude))%>%
  
 mutate(latitude = if_else(site_code == "BMSC15", 48.88028336, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC15", -125.3128815, longitude))%>% 
  
 mutate(latitude = if_else(site_code == "BMSC16", 48.89070129, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC16", -125.300499, longitude))%>% 
  
 mutate(latitude = if_else(site_code == "BMSC17", 48.86548233, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC17", -125.3614807, longitude))%>% 
  
mutate(latitude = if_else(site_code == "BMSC18", 48.91161728, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC18", -125.2670364, longitude))%>% 
  
 mutate(latitude = if_else(site_code == "BMSC19", 48.82860184, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC19", -125.2212982, longitude))%>%  
  
 mutate(latitude = if_else(site_code == "BMSC20", 48.83566666, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC20", -125.214798, longitude))%>%  
  
mutate(latitude = if_else(site_code == "BMSC21", 48.85205078, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC21", -125.1235657, longitude))%>%    
  
 mutate(latitude = if_else(site_code == "BMSC22", 48.85426712, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC22", -125.1170349, longitude))%>%    
  
  mutate(latitude = if_else(site_code == "BMSC23", 48.837589, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC23", -125.144145, longitude))%>%     
  
    mutate(latitude = if_else(site_code == "BMSC24", 48.916073, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC24", -125.131174, longitude))%>%
  
     mutate(latitude = if_else(site_code == "BMSC24", 48.916073, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC24", -125.131174, longitude))%>%
  
      mutate(latitude = if_else(site_code == "BMSC25", 48.838595, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC25", -125.135015, longitude))%>% 
  
        mutate(latitude = if_else(site_code == "BMSC26", 48.9071, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC26", -125.037017, longitude))%>% 
  
     mutate(latitude = if_else(site_code == "BMSC27", 48.901183, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC27", -125.060433, longitude))
```

```{r Converting to form with a column for each species}
overall_rls_data_raw_wide <- overall_rls_data_raw_lat_long%>%
  select(-c("FID", "survey_id", "country", "area", "ecoregion", "realm", "location", "program",
            "survey_latitude", "survey_longitude"))%>%
  group_by(site_code, site_name, latitude, longitude, survey_date, depth, reporting_name)%>%
  summarise(site_count = sum(total))

overall_rls_data_raw_wide$reporting_name <- as.factor(overall_rls_data_raw_wide$reporting_name)

overall_rls_data_raw_wide <- overall_rls_data_raw_wide%>%
  mutate(reporting_name = str_replace_all(reporting_name, " ", "_"))%>%
  pivot_wider(
    names_from = reporting_name,
    values_from = site_count,
    values_fill = 0
  )
```


```{r Cutting the other sites and adding the information to do some modelling}
#Cutting the other sites
overall_rls_data_clean <- overall_rls_data_raw_wide%>%
  filter(site_code %in% c("BMSC1", "BMSC10", "BMSC11", "BMSC12", "BMSC13", "BMSC14", "BMSC15",
                          "BMSC16", "BMSC17", "BMSC18", "BMSC19", "BMSC2", "BMSC20", "BMSC21",
                          "BMSC22", "BMSC23", "BMSC24", "BMSC25", "BMSC26", "BMSC27", "BMSC3",
                          "BMSC31", "BMSC32", "BMSC33", "BMSC4", "BMSC5", "BMSC6", "BMSC7",
                          "BMSC8", "BMSC9"))%>%
#Adding the protection status to the dataset
mutate(protection_status = case_when(
  site_code %in% c("BMSC1", "BMSC10", "BMSC11", "BMSC12", "BMSC13", "BMSC14", "BMSC19", 
                   "BMSC2", "BMSC20", "BMSC21", "BMSC22", "BMSC23", "BMSC24", "BMSC25",
                   "BMSC27", "BMSC3", "BMSC31", "BMSC32", "BMSC33", "BMSC4", "BMSC5", "BMSC9") ~ "unprotected",
  site_code %in% c("BMSC15", "BMSC16", "BMSC17", "BMSC18", "BMSC26", "BMSC6", "BMSC7", "BMSC8") ~ "protected"
))

overall_rls_data_clean <- overall_rls_data_clean[,c(seq(1, 6, by = 1), 182, seq(7, 181, by = 1))]
```

## Making some specific columns for modelling


```{r Making specific groups for modelling}
overall_rls_data_groups <- overall_rls_data_clean%>%
  mutate(total_urchins = Mesocentrotus_franciscanus + Strongylocentrotus_purpuratus + Strongylocentrotus_droebachiensis,
         total_fish = Actinopterygii_spp. + Anarrhichthys_ocellatus + Anoplarchus +
           Apodichthys_flavidus + Artedius_fenestralis + Artedius_harringtoni + Artedius_lateralis+
           Ascelichthys_rhodorus + Asemichthys_taylori + Aulorhynchus_flavidus + Brachyistius_frenatus +
           Chirolophis_nugator + Citharichthys_stigmaeus + Clinocottus_acuticeps + Cottid_spp. +
           Cymatogaster_aggregata + Embiotoca_lateralis + Enophrys_bison + Gibbonsia_metzi + Gobiesox_maeandricus +
           Hemilepidotus + Hemilepidotus_hemilepidotus + Hemilepidotus_spinosus + Hexagrammos +
           Hexagrammos_decagrammus + Hexagrammos_stelleri + Jordania_zonope + Liparis_florae + Myoxocephalus_aenaeus +
           Myoxocephalus_polyacanthocephalus + Oligocottus_maculosus + Ophiodon_elongatus + Orthonopias_triacis+
           Oxylebius_pictus + Phoca_vitulina + Pholis + Pholis_clemensi + Pholis_gunnellus + Pholis_laeta +
           Pholis_ornata + Pleuronichthys_coenosus + Porichthys_notatus + Rhacochilus_vacca +
           Rhamphocottus_richardsonii + Rhinogobiops_nicholsii + Rhinogobiops_nicholsii +
           Scorpaenichthys_marmoratus + Sebastes_caurinus + Sebastes_flavidus + Sebastes_maliger + Sebastes_melanops +
           Sebastes_nebulosus + Sebastes_pinniger + Sebastes_spp. + Synchirus_gilli + Zalophus_californianus,
         total_rockfish = Sebastes_spp. + Sebastes_pinniger + Sebastes_caurinus + Sebastes_maliger + Sebastes_melanops +
           Sebastes_nebulosus + Sebastes_flavidus)
```

```{r}
ggplot(overall_rls_data_groups, aes(x = protection_status, y = total_rockfish))+
  geom_boxplot()
```


# Initial modelling
