---
title: "urchin_RLS_manu"
author: "Alec Jones"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
   toc: true
---

   <script src="hideOutput.js"></script> 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(sdmTMB)
library(sf)
library(ggspatial)
library(cowplot)
library(waver)
library(lubridate)
library(eks)
library(tmap)
```

For this project I am continuing on from the work I did for my Honours and pivoting away from just looking at the red turban snails and red sea urchins within Barkley Sound based on environmental drivers and protection from fishing status. I will be looking at only protection from fishing status and looking at urchins in general, fish, and kelp communities to get a more complete picture of the effectiveness or lack thereof of protected areas within Barkley Sound.

# Loading in the data

For this analysis I will be using four years of data from the RLS surveys instead of only 1. I will need to download the RLS data from the website and combine the three files together (mobile fish, cryptobenthic fish, macroinverts)

```{r Downloading the macroinvert data, echo=FALSE}
#Reading in the macroinvert data from the csv downloaded from the RLS website

macroinvert_data_raw <- read_csv(here("./01_raw_data/cleaned_Global_mobile_macroinvertebrate_abundance.csv"))
```

```{r Loading in the cryptobenthic fish data, echo=FALSE}
cryptobenthic_fish_data_raw <- read_csv(here("./01_raw_data/cleaned_Global_cryptobenthic_fish_abundance.csv"))
```

```{r Loading in the mobile fish data, echo=FALSE}
mobile_fish_data_raw <- read_csv(here("./01_raw_data/cleaned_Global_reef_fish_abundance_and_biomass.csv"))
```

## Testing the data

```{r Testing to see if the fish data needs to be combined or not}
#test_mobile <- mobile_fish_data_raw%>%
 # filter(site_code == "BMSC1" & reporting_name == "Rhinogobiops nicholsii" 
    #     & survey_date == "2023-05-15")

#test_cryptic <- cryptobenthic_fish_data_raw%>%
#  filter(site_code == "BMSC1" & reporting_name == "Rhinogobiops nicholsii" 
   #      & survey_date == "2023-05-15")
```

After checking it appears that the cryptic fish and mobile fish csv files need to be combined and then the counts match up with the Excel sheet supplied.


# Cleaning up the data for use

## Combining the three dfs into one overall and cleaning up for use

```{r Combining the three DFs}
overall_rls_data_raw <- rbind(cryptobenthic_fish_data_raw, macroinvert_data_raw,
                              mobile_fish_data_raw)
```


```{r Correcting the lat and long to be correct}
overall_rls_data_raw_lat_long <- overall_rls_data_raw%>%
 mutate(latitude = if_else(site_code == "BMSC1", 48.82894897, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC1", -125.1975708, longitude))%>%
  
   mutate(latitude = if_else(site_code == "BMSC2", 48.85039902, latitude))%>%
   mutate(longitude = if_else(site_code == "BMSC2", -125.1987686, longitude))%>%
  
 mutate(latitude = if_else(site_code == "BMSC3", 48.85558319, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC3", -125.1837997, longitude))%>%
  
   mutate(latitude = if_else(site_code == "BMSC4", 48.81511688, latitude))%>%
   mutate(longitude = if_else(site_code == "BMSC4", -125.1753311, longitude))%>%
  
 mutate(latitude = if_else(site_code == "BMSC5", 48.82733154, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC5", -125.1966019, longitude))%>%
  
   mutate(latitude = if_else(site_code == "BMSC6", 48.95023346, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC6", -125.1555481, longitude))%>%
  
  mutate(latitude = if_else(site_code == "BMSC7", 48.954644, latitude))%>%
  mutate(longitude = if_else(site_code == "BMSC7", -125.153993, longitude))%>%
  
    mutate(latitude = if_else(site_code == "BMSC8", 48.95508194, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC8", -125.1533737, longitude))%>%

    mutate(latitude = if_else(site_code == "BMSC9", 48.83478928, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC9", -125.1470261, longitude))%>%
  
 mutate(latitude = if_else(site_code == "BMSC10", 48.87051773, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC10", -125.160347, longitude))%>%
  
 mutate(latitude = if_else(site_code == "BMSC11", 48.85746765, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC11", -125.1582336, longitude))%>%
  
  mutate(latitude = if_else(site_code == "BMSC12", 48.858284, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC12", -125.1609192, longitude))%>%
  
mutate(latitude = if_else(site_code == "BMSC13", 48.8650322, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC13", -125.3137207, longitude))%>%
  
mutate(latitude = if_else(site_code == "BMSC14", 48.87908173, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC14", -125.2974014, longitude))%>%
  
 mutate(latitude = if_else(site_code == "BMSC15", 48.88028336, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC15", -125.3128815, longitude))%>% 
  
 mutate(latitude = if_else(site_code == "BMSC16", 48.89070129, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC16", -125.300499, longitude))%>% 
  
 mutate(latitude = if_else(site_code == "BMSC17", 48.86548233, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC17", -125.3614807, longitude))%>% 
  
mutate(latitude = if_else(site_code == "BMSC18", 48.91161728, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC18", -125.2670364, longitude))%>% 
  
 mutate(latitude = if_else(site_code == "BMSC19", 48.82860184, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC19", -125.2212982, longitude))%>%  
  
 mutate(latitude = if_else(site_code == "BMSC20", 48.83566666, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC20", -125.214798, longitude))%>%  
  
mutate(latitude = if_else(site_code == "BMSC21", 48.85205078, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC21", -125.1235657, longitude))%>%    
  
 mutate(latitude = if_else(site_code == "BMSC22", 48.85426712, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC22", -125.1170349, longitude))%>%    
  
  mutate(latitude = if_else(site_code == "BMSC23", 48.837589, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC23", -125.144145, longitude))%>%     
  
    mutate(latitude = if_else(site_code == "BMSC24", 48.916073, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC24", -125.131174, longitude))%>%
  
     mutate(latitude = if_else(site_code == "BMSC24", 48.916073, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC24", -125.131174, longitude))%>%
  
      mutate(latitude = if_else(site_code == "BMSC25", 48.838595, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC25", -125.135015, longitude))%>% 
  
        mutate(latitude = if_else(site_code == "BMSC26", 48.9071, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC26", -125.037017, longitude))%>% 
  
     mutate(latitude = if_else(site_code == "BMSC27", 48.901183, latitude))%>%
 mutate(longitude = if_else(site_code == "BMSC27", -125.060433, longitude))
```

```{r Converting species with duplicate names to the accepted one}
overall_rls_data_raw_lat_long_updated_names <- overall_rls_data_raw_lat_long%>%
  mutate(reporting_name = if_else(reporting_name == "Phyllolithodes papillosus",
                                  "Echidnocerus cibarius", reporting_name))
```



```{r Converting to form with a column for each species}
overall_rls_data_raw_wide <- overall_rls_data_raw_lat_long_updated_names%>%
  select(-c("FID", "survey_id", "country", "area", "ecoregion", "realm", "location", "program",
            "survey_latitude", "survey_longitude"))%>%
  group_by(site_code, site_name, latitude, longitude, survey_date, depth, reporting_name)%>%
  summarise(site_count = sum(total))

overall_rls_data_raw_wide$reporting_name <- as.factor(overall_rls_data_raw_wide$reporting_name)

overall_rls_data_raw_wide <- overall_rls_data_raw_wide%>%
  mutate(reporting_name = str_replace_all(reporting_name, " ", "_"))%>%
  pivot_wider(
    names_from = reporting_name,
    values_from = site_count,
    values_fill = 0
  )
```


I have decided to cut the three sites BMSC 31, 32, 33 as they were only sampled in 2023 and none of the other years. Additionally I do not have the exact lat and longs for them.
```{r Cutting the other sites and adding the information to do some modelling}
#Cutting the other sites

overall_rls_data_clean <- overall_rls_data_raw_wide%>%
  filter(site_code %in% c("BMSC1", "BMSC10", "BMSC11", "BMSC12", "BMSC13", "BMSC14", "BMSC15",
                          "BMSC16", "BMSC17", "BMSC18", "BMSC19", "BMSC2", "BMSC20", "BMSC21",
                          "BMSC22", "BMSC23", "BMSC24", "BMSC25", "BMSC26", "BMSC27", "BMSC3", "BMSC4", "BMSC5", "BMSC6", "BMSC7",
                          "BMSC8", "BMSC9"))%>%
#Adding the protection status to the dataset
mutate(protection_status = case_when(
  site_code %in% c("BMSC1", "BMSC10", "BMSC11", "BMSC12", "BMSC13", "BMSC14", "BMSC19", 
                   "BMSC2", "BMSC20", "BMSC21", "BMSC22", "BMSC23", "BMSC24", "BMSC25",
                   "BMSC27", "BMSC3", "BMSC31", "BMSC32", "BMSC33", "BMSC4", "BMSC5", "BMSC9") ~ "unprotected",
  site_code %in% c("BMSC15", "BMSC16", "BMSC17", "BMSC18", "BMSC26", "BMSC6", "BMSC7", "BMSC8") ~ "protected"
))

overall_rls_data_clean <- overall_rls_data_clean[,c(seq(1, 6, by = 1), 181,
                                                    seq(7, 180, by = 1))]

overall_rls_data_clean$site_code <- as.factor(overall_rls_data_clean$site_code)
overall_rls_data_clean$site_name <- as.factor(overall_rls_data_clean$site_name)
overall_rls_data_clean$protection_status <- as.factor(overall_rls_data_clean$protection_status)
```


## Making some specific columns for modelling


```{r Making specific groups for modelling}
overall_rls_data_groups <- overall_rls_data_clean%>%
  mutate(total_urchins = Mesocentrotus_franciscanus + Strongylocentrotus_purpuratus + Strongylocentrotus_droebachiensis,
         total_fish = Actinopterygii_spp. + Anarrhichthys_ocellatus + Anoplarchus +
           Apodichthys_flavidus + Artedius_fenestralis + Artedius_harringtoni + Artedius_lateralis+
           Ascelichthys_rhodorus + Asemichthys_taylori + Aulorhynchus_flavidus + Brachyistius_frenatus +
           Chirolophis_nugator + Citharichthys_stigmaeus + Clinocottus_acuticeps + Cottid_spp. +
           Cymatogaster_aggregata + Embiotoca_lateralis + Enophrys_bison + Gibbonsia_metzi + Gobiesox_maeandricus +
           Hemilepidotus + Hemilepidotus_hemilepidotus + Hemilepidotus_spinosus + Hexagrammos +
           Hexagrammos_decagrammus + Hexagrammos_stelleri + Jordania_zonope + Liparis_florae + Myoxocephalus_aenaeus +
           Myoxocephalus_polyacanthocephalus + Oligocottus_maculosus + Ophiodon_elongatus + Orthonopias_triacis+
           Oxylebius_pictus + Phoca_vitulina + Pholis + Pholis_clemensi + Pholis_gunnellus + Pholis_laeta +
           Pholis_ornata + Pleuronichthys_coenosus + Porichthys_notatus + Rhacochilus_vacca +
           Rhamphocottus_richardsonii + Rhinogobiops_nicholsii + Rhinogobiops_nicholsii +
           Scorpaenichthys_marmoratus + Sebastes_caurinus + Sebastes_flavidus + Sebastes_maliger + Sebastes_melanops +
           Sebastes_nebulosus + Sebastes_pinniger + Sebastes_spp. + Synchirus_gilli + Zalophus_californianus,
         total_rockfish = Sebastes_spp. + Sebastes_pinniger + Sebastes_caurinus + Sebastes_maliger + Sebastes_melanops +
           Sebastes_nebulosus + Sebastes_flavidus,
         total_mesograzers = Acmaea_mitra + Amphissa_columbiana + Calliostoma_ligatum + Diodora_aspera + Haliotis_kamtschatkana +
           Lottia + Lottia_scutum + Megathura_crenulata + Mesocentrotus_franciscanus + Mimulus_foliatus +
           Pagurus_hemphilli + Pomaulax_gibberosus + Pugettia_foliata + Pugettia_gracilis + Pugettia_producta +
           Pugettia_richii + Strongylocentrotus_droebachiensis + Strongylocentrotus_purpuratus + Tegula_funebralis,
         mesograzers_w_o_urchins = Acmaea_mitra + Amphissa_columbiana + Calliostoma_ligatum + Diodora_aspera + Haliotis_kamtschatkana +
           Lottia + Lottia_scutum + Megathura_crenulata + Mimulus_foliatus +
           Pagurus_hemphilli + Pomaulax_gibberosus + Pugettia_foliata + Pugettia_gracilis + Pugettia_producta +
           Pugettia_richii + Tegula_funebralis,
         total_nudibranchs = Acanthodoris_hudsoni + Acanthodoris_nanaimoensis + Aglaja_ocelligera +
           Aldisa + Antiopella_fusca + Armina_californica + Boreoberthella_chacei + Cadlina + Cadlina_luteomarginata +
           Cadlina_modesta + Cadlina_sylviaearleae + Coryphella_trilineata + Coryphella_trophina + Coryphella_verrucosa +
           Dendronotus_albus + Dendronotus_iris + Diaulula_odonoghuei + Diaulula_sandiegensis +
           Dirona_albolineata + Dirona_pellucida + Doris_montereyensis + Doris_odhneri + 
           Geitodoris_heathi + Hermissenda_crassicornis + Limacia_cockerelli + Montereina_nobilis +
           Onchidoris_bilamellata + Polycera_tricolor + Rostanga_pulchra + Triopha_catalinae + Triopha_modesta +
           Triopha_spp. + Tritonia_festiva)
```


```{r Adding a column for year}
#Extracting the year from the date column and then making a new column called
#year
overall_rls_data_groups$year <- format(overall_rls_data_groups$survey_date, "%Y")

#reordering the df
#overall_rls_data_groups <- overall_rls_data_groups[,c(seq(1, 5, by = 1), 192,
  #                                                  seq(6, 191, by = 1))]

overall_rls_data_groups$year <- as.numeric(overall_rls_data_groups$year)
```


```{r Adding a column for the regions for each site}
  overall_rls_data_groups <- overall_rls_data_groups%>%
  mutate(region = case_when(
    site_code %in% c("BMSC1", "BMSC10", "BMSC11", "BMSC12", "BMSC19", "BMSC2",
                     "BMSC20", "BMSC21", "BMSC22", "BMSC23", "BMSC25", "BMSC3",
                     "BMSC4", "BMSC5", "BMSC9") ~ "Deer group/Bamfield",
    site_code %in% c("BMSC13", "BMSC14", "BMSC15", "BMSC16", "BMSC17", 
                     "BMSC18") ~ "Broken Group",
    site_code %in% c("BMSC24", "BMSC6", "BMSC7", "BMSC8") ~ "Deep Imperial Eagle Channel",
    site_code %in% c("BMSC26", "BMSC27") ~ "Sarita"
  ))
  

#overall_rls_data_groups <- overall_rls_data_groups[, c(1, 2, 193, seq(3, 192, by = 1))]
```


```{r Adding columns for site kelp characteristics}
overall_rls_data_groups <- overall_rls_data_groups%>%
  mutate(kelp = case_when(
    site_code %in% c("BMSC15", "BMSC26") ~ "Forest",
    site_code %in% c("BMSC10") ~ "Prior forest",
    site_code %in% c("BMSC22", "BMSC4", "BMSC17") ~ "Prior understory",
    site_code %in% c("BMSC1") ~ "Understory",
   #This makes all the remaining ones equal to barren
     TRUE ~ "Barren"
  ))%>%
  mutate(kelp_pa = case_when(
    kelp %in% c("Forest", "Understory") ~ "Present",
    kelp %in% c("Prior forest", "Prior understory", "Barren") ~ "Absent"
  ))


#overall_rls_data_groups <- overall_rls_data_groups[, c(1, 2, 3, 194, seq(4, 193, by = 1))]
```


## Calculating and adding the openness of each site to the data frame

```{r Making dfs of the unique sites and then just the lat and long, echo=FALSE, include=FALSE}
#Making a df with just the unique site info
site_data <- overall_rls_data_groups%>%
  distinct(site_code, site_name, latitude, longitude)

#Making a df with just the unique lat and longs
site_coords <- site_data%>%
  ungroup()%>%
  select(latitude, longitude)%>%
  distinct()

#This converts the site coordinates into a sf object and specifies the 
#coordinate reference system to be the same as the shape file
site_sp <- st_as_sf(site_coords, coords = c("longitude", "latitude"), crs = 4326)
```


```{r Loading in the shapefiles to do the fetch calculations, include=FALSE}
#This is a high resolution shape file from Hakai. This code loads in the shape
#file and saves it as the proper shape file object
VI_base_layer_hi_res <- read_sf(dsn = here("./01_raw_data/hakai_zip"),
                                stringsAsFactors = F)

VI_base_layer_hi_res_sf <- st_as_sf(VI_base_layer_hi_res)

#specifying the projection to use for the sf
st_crs(VI_base_layer_hi_res_sf) <- "+proj=longlat +datum=WGS84 +no_defs"



#This subsets the shape file to only be of Barkley Sound to make plotting more
#efficient

#This makes coordinate limits to subset the shapefile
shp_xmin <- -125.4
shp_xmax <- -124.95
shp_ymin <- 48.7
shp_ymax <- 49.0

#This makes a bounding of the coordinates that I just made
bbox <- st_bbox(c(xmin = shp_xmin, ymin = shp_ymin, xmax = shp_xmax, ymax = shp_ymax))

#This converts the boundary box to an SFC object
bbox_sf <- st_as_sfc(bbox)

#This crops the shape file to the area of the bounding box
VI_base_layer_hi_res_sf_subset <- st_crop(VI_base_layer_hi_res_sf, bbox_sf)
#plot(VI_base_layer_hi_res_sf_subset)
```

```{r Calculating the fetch for the sites, eval=FALSE}
#Makes an object of all the bearings to calculate fetch along
bearings_openness <- seq(7.5, 360, by = 7.5)

#Specifies to use the GEOS engine
sf::sf_use_s2(FALSE)

#This calculates the fetch for each site along each of the bearings calculated
#above. Max possible fetch is 650,000 meters. It is using the shape file from 
#above to know where land is. This will likely take a very long time to run
#so do not worry.
#I have ## this code out because it takes way too long to run. There is code in
#the chunk below that will load in the data from a .csv that has already been
#made by running the fetch_len_multi function

fetch_df_openness <- fetch_len_multi(site_sp,
                                         bearings = bearings_openness, 
                                          dmax = 650000, 
                                          shoreline = VI_base_layer_hi_res_sf, 
                                          projected = FALSE)

#Converting the raw fetch data into a df
fetch_df_openness <- as.data.frame(fetch_df_openness)

#Saving the fetch data to a .csv so that the fetch function does not need to be
#run
write_csv(fetch_df_openness, here("./01_raw_data/fetch_df_openness.csv"))
```

```{r Loading in the pre calculated fetch data, echo=FALSE}
fetch_df_openness <- read_csv(here("./01_raw_data/fetch_df_openness.csv"))
```

```{r Turning the raw openness fetch data into a dataframe with column labels}
#Making an object with all of the site code names listed to be able to make a
#column of site codes in the fetch df below
site_code <- unique(overall_rls_data_groups$site_code)

#Adding a column with the site codes
fetch_df_openness$site_code <- site_code
#Adding a column with the site lat
fetch_df_openness$latitude <- site_coords$latitude
#Adding a column with the site long
fetch_df_openness$longitude <- site_coords$longitude

#Reorganizing the order of the columns so that site code, lat, and long are 
#first
fetch_df_openness_final <- fetch_df_openness[, c(49, 50, 51, seq(1, 48, by = 1))]

#Converting into long format for further analysis and adding to the RLS data
fetch_df_openness_long <- fetch_df_openness_final%>%
  #Makes column with bearing degree and column with corresponding fetch
  pivot_longer(cols = `7.5`: `360`, 
               names_to = "degree", 
               values_to = "fetch", 
               #Removes the prefix "degree" from the values going into the 
               #degree column
               names_prefix = "degree")
```

```{r Summing the fetch vectors for each site then dividing by the largest openness value}
#Calculates the openness of each site
openness <- fetch_df_openness_long%>%
  #grouping by each site
  group_by(site_code, latitude, longitude)%>%
  #adding up all of the fetch vectors for each site
  summarise(openness = sum(fetch))
  
#identifying the largest openness score within the dataset
max_openness <- max(openness$openness)

#Making a column of normalized openness by dividing by the max observed openness
openness <- openness%>%
mutate(norm_openness = openness / max_openness)

#Merging the modelling df with the openness df by each site
overall_rls_data_groups_with_openness <- merge(overall_rls_data_groups, openness, by = c("site_code", "latitude", "longitude"))
```

## Making a DF with fish sizes overall

```{r Expanding the long format data so that each individual fish has its own row}
overall_rls_data_expanded <- overall_rls_data_raw_lat_long%>%
  filter(phylum == "Chordata")%>%
  filter(class != "Mammalia")%>%
  #This replicates each row by the number of counts of each fish in total
  uncount(total)
```

```{r Cleaning up the data and adding the necessary variables}
#Removing unnecessary columns
overall_rls_data_expanded <- overall_rls_data_expanded%>%
  select(-c("FID", "survey_id", "country", "area", "ecoregion", "realm", "location", "program",
            "survey_latitude", "survey_longitude", "geom"))


#Cutting the other sites
overall_rls_data_expanded <- overall_rls_data_expanded%>%
  filter(site_code %in% c("BMSC1", "BMSC10", "BMSC11", "BMSC12", "BMSC13", "BMSC14", "BMSC15",
                          "BMSC16", "BMSC17", "BMSC18", "BMSC19", "BMSC2", "BMSC20", "BMSC21",
                          "BMSC22", "BMSC23", "BMSC24", "BMSC25", "BMSC26", "BMSC27", "BMSC3", "BMSC4", "BMSC5", "BMSC6", "BMSC7",
                          "BMSC8", "BMSC9"))%>%
#Adding the protection status to the dataset
mutate(protection_status = case_when(
  site_code %in% c("BMSC1", "BMSC10", "BMSC11", "BMSC12", "BMSC13", "BMSC14", "BMSC19", 
                   "BMSC2", "BMSC20", "BMSC21", "BMSC22", "BMSC23", "BMSC24", "BMSC25",
                   "BMSC27", "BMSC3", "BMSC31", "BMSC32", "BMSC33", "BMSC4", "BMSC5", "BMSC9") ~ "unprotected",
  site_code %in% c("BMSC15", "BMSC16", "BMSC17", "BMSC18", "BMSC26", "BMSC6", "BMSC7", "BMSC8") ~ "protected"
))

overall_rls_data_expanded$site_code <- as.factor(overall_rls_data_expanded$site_code)
overall_rls_data_expanded$site_name <- as.factor(overall_rls_data_expanded$site_name)
overall_rls_data_expanded$protection_status <- as.factor(overall_rls_data_expanded$protection_status)


#Extracting the year from the date column and then making a new column called
#year
overall_rls_data_expanded$year <- format(overall_rls_data_expanded$survey_date, "%Y")

overall_rls_data_expanded$year <- as.numeric(overall_rls_data_expanded$year)

#Adding columns for site kelp characteristics
overall_rls_data_expanded <- overall_rls_data_expanded%>%
  mutate(kelp = case_when(
    site_code %in% c("BMSC15", "BMSC26") ~ "Forest",
    site_code %in% c("BMSC10") ~ "Prior forest",
    site_code %in% c("BMSC22", "BMSC4", "BMSC17") ~ "Prior understory",
    site_code %in% c("BMSC1") ~ "Understory",
   #This makes all the remaining ones equal to barren
     TRUE ~ "Barren"
  ))

overall_rls_data_expanded <- overall_rls_data_expanded%>%
  mutate(kelp_pa = case_when(
    kelp %in% c("Forest", "Understory") ~ "Present",
    kelp %in% c("Prior forest", "Prior understory", "Barren") ~ "Absent"
  ))
```


## Making a df for plotting community composition

```{r}
overall_rls_data_expanded_with_all_species <- overall_rls_data_raw_lat_long%>%
  uncount(total)


#Removing unnecessary columns
overall_rls_data_expanded_with_all_species <- overall_rls_data_expanded_with_all_species%>%
  select(-c("FID", "survey_id", "country", "area", "ecoregion", "realm", "location", "program",
            "survey_latitude", "survey_longitude", "geom"))%>%
  filter(site_code %in% c("BMSC1", "BMSC10", "BMSC11", "BMSC12", "BMSC13", "BMSC14", "BMSC15",
                          "BMSC16", "BMSC17", "BMSC18", "BMSC19", "BMSC2", "BMSC20", "BMSC21",
                          "BMSC22", "BMSC23", "BMSC24", "BMSC25", "BMSC26", "BMSC27", "BMSC3", "BMSC4", "BMSC5", "BMSC6", "BMSC7",
                          "BMSC8", "BMSC9"))%>%
#Adding the protection status to the dataset
mutate(protection_status = case_when(
  site_code %in% c("BMSC1", "BMSC10", "BMSC11", "BMSC12", "BMSC13", "BMSC14", "BMSC19", 
                   "BMSC2", "BMSC20", "BMSC21", "BMSC22", "BMSC23", "BMSC24", "BMSC25",
                   "BMSC27", "BMSC3", "BMSC31", "BMSC32", "BMSC33", "BMSC4", "BMSC5", "BMSC9") ~ "unprotected",
  site_code %in% c("BMSC15", "BMSC16", "BMSC17", "BMSC18", "BMSC26", "BMSC6", "BMSC7", "BMSC8") ~ "protected"
))


overall_rls_data_expanded_with_all_species$site_code <- as.factor(overall_rls_data_expanded_with_all_species$site_code)
overall_rls_data_expanded_with_all_species$site_name <- as.factor(overall_rls_data_expanded_with_all_species$site_name)
overall_rls_data_expanded_with_all_species$protection_status <- as.factor(overall_rls_data_expanded_with_all_species$protection_status)


#Extracting the year from the date column and then making a new column called
#year
overall_rls_data_expanded_with_all_species$year <- format(overall_rls_data_expanded_with_all_species$survey_date, "%Y")

overall_rls_data_expanded_with_all_species$year <- as.numeric(overall_rls_data_expanded_with_all_species$year)

#Adding columns for site kelp characteristics
overall_rls_data_expanded_with_all_species <- overall_rls_data_expanded_with_all_species%>%
  mutate(kelp = case_when(
    site_code %in% c("BMSC15", "BMSC26") ~ "Forest",
    site_code %in% c("BMSC10") ~ "Prior forest",
    site_code %in% c("BMSC22", "BMSC4", "BMSC17") ~ "Prior understory",
    site_code %in% c("BMSC1") ~ "Understory",
   #This makes all the remaining ones equal to barren
     TRUE ~ "Barren"
  ))%>%
  mutate(kelp_pa = case_when(
    kelp %in% c("Forest", "Understory") ~ "Present",
    kelp %in% c("Prior forest", "Prior understory", "Barren") ~ "Absent"
  ))
```

## Making a df for plotting community comp without urchins

```{r}
overall_rls_data_expanded_no_urch <- overall_rls_data_raw_lat_long%>%
  filter(!reporting_name %in% c("Mesocentrotus franciscanus", "Strongylocentrotus purpuratus",
                                "Strongylocentrotus droebachiensis"))%>%
  uncount(total)

#Removing unnecessary columns
overall_rls_data_expanded_no_urch <- overall_rls_data_expanded_no_urch%>%
  select(-c("FID", "survey_id", "country", "area", "ecoregion", "realm", "location", "program",
            "survey_latitude", "survey_longitude", "geom"))%>%
  filter(site_code %in% c("BMSC1", "BMSC10", "BMSC11", "BMSC12", "BMSC13", "BMSC14", "BMSC15",
                          "BMSC16", "BMSC17", "BMSC18", "BMSC19", "BMSC2", "BMSC20", "BMSC21",
                          "BMSC22", "BMSC23", "BMSC24", "BMSC25", "BMSC26", "BMSC27", "BMSC3", "BMSC4", "BMSC5", "BMSC6", "BMSC7",
                          "BMSC8", "BMSC9"))%>%
#Adding the protection status to the dataset
mutate(protection_status = case_when(
  site_code %in% c("BMSC1", "BMSC10", "BMSC11", "BMSC12", "BMSC13", "BMSC14", "BMSC19", 
                   "BMSC2", "BMSC20", "BMSC21", "BMSC22", "BMSC23", "BMSC24", "BMSC25",
                   "BMSC27", "BMSC3", "BMSC31", "BMSC32", "BMSC33", "BMSC4", "BMSC5", "BMSC9") ~ "unprotected",
  site_code %in% c("BMSC15", "BMSC16", "BMSC17", "BMSC18", "BMSC26", "BMSC6", "BMSC7", "BMSC8") ~ "protected"
))


overall_rls_data_expanded_no_urch$site_code <- as.factor(overall_rls_data_expanded_no_urch$site_code)
overall_rls_data_expanded_no_urch$site_name <- as.factor(overall_rls_data_expanded_no_urch$site_name)
overall_rls_data_expanded_no_urch$protection_status <- as.factor(overall_rls_data_expanded_no_urch$protection_status)


#Extracting the year from the date column and then making a new column called
#year
overall_rls_data_expanded_no_urch$year <- format(overall_rls_data_expanded_no_urch$survey_date, "%Y")

overall_rls_data_expanded_no_urch$year <- as.numeric(overall_rls_data_expanded_no_urch$year)

#Adding columns for site kelp characteristics
overall_rls_data_expanded_no_urch <- overall_rls_data_expanded_no_urch%>%
  mutate(kelp = case_when(
    site_code %in% c("BMSC15", "BMSC26") ~ "Forest",
    site_code %in% c("BMSC10") ~ "Prior forest",
    site_code %in% c("BMSC22", "BMSC4", "BMSC17") ~ "Prior understory",
    site_code %in% c("BMSC1") ~ "Understory",
   #This makes all the remaining ones equal to barren
     TRUE ~ "Barren"
  ))%>%
  mutate(kelp_pa = case_when(
    kelp %in% c("Forest", "Understory") ~ "Present",
    kelp %in% c("Prior forest", "Prior understory", "Barren") ~ "Absent"
  ))
```


## Making a theme for all subsequent figures

```{r Making theme for all subsequent figures, echo=FALSE}
theme.figure <- function (){
  theme_bw(base_size = 12) +
  theme(panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    #axis.line = element_line(colour = "black"),
    axis.title = element_text(size = 16, face = "bold"),
    axis.text = element_text(size = 14, face = "plain"),
    legend.text = element_text(size = 12, face = "plain"),
    legend.title = element_text(size = 14, face = "bold")) 
}
```


## Adding recreational fishing boat location data to the data frame

In my honours I used recreational fishing boat fishing locations to support the classifications of sites as either protected or unprotected. I will be including that analysis within this project as well but will be updating it slightly to use a geometric mean instead to account for the skew in the counts.

In order to use the site protection status as a predictor, we needed to find
support for the fact that there was in fact a difference in the human impacts
between protected and unprotected sites.

To do this we used DFO flyover survey data that included the positions of where
recreational fishing boats were located in Barkley Sound. 

We used the DFO flyover counts of recreational boats actively fishing to 
calculate the annual mean number of recreational boats fishing within a given 
radius of each site to support the site protection status classifications and 
show that human impacts were higher for unprotected sites. To calculate the 
annual mean number of recreational boats fishing within a given radius of each 
site, we constructed circular polygons around each site (radii = 1 km, 1.5 km, 
2 km) using R (R Core Team, 2024). We merged these polygons with the DFO 
recreational boat counts to extract how many boats were spotted within the 
radius in each year. To get the annual mean, we averaged these counts across 
the three years of data from DFO (2021, 2022, 2023). We omitted aerial surveys 
where parts of Barkley Sound were obscured by fog.

### Loading in the DFO survey data

#### Loading in the 2023 data

```{r Loading in the  2023 DFO data}
DFO_data_raw_2023 <- read_csv(here("./01_raw_data/DFO_data/Overflight2023_ObservationPoints_20241024.csv"))

#Makes list of the variables that need to be converted to factors below
dfo_factors <- c("Day Type", "Creel Subarea")

#takes the raw data and cleans it up
rec_boats_fishing2023 <- DFO_data_raw_2023%>%
  #converts the variables specified above to factors
  mutate_at(dfo_factors, factor)%>%
  #renaming the columns to make them easier to code with
  rename(rec_boats_fishing = `1. Rec Boat Fishing`,
         rec_boats_running = `2. Rec Boats Running`,
         comm_vessel_fishing = `3. Commercial Vessel Fishing`,
         comm_vessel_not_fishing = `4. Commercial Vessel Not Fishing`,
         small_comm_vessel = `5. Small Commercial Vessel`,
         large_comm_vessel = `6. Large Commercial Vessel`,
         whale_watching = `7.  Whale Watching Boat`,
         orcas = `8. Orcas`,
         whales = `9. Whales`,
         sea_state = `10. Sea State`)%>%
  #Replacing the cells that have "Null" with 0 and converting the count columns
  #to numeric
  mutate(across(c("rec_boats_fishing", "rec_boats_running", "comm_vessel_fishing", 
                  "comm_vessel_not_fishing", "small_comm_vessel", "large_comm_vessel",
                  "whale_watching", "orcas", "whales"), ~ ifelse(. == "<Null>", 0, .)),
         across(c("rec_boats_fishing", "rec_boats_running", "comm_vessel_fishing", 
                  "comm_vessel_not_fishing", "small_comm_vessel", "large_comm_vessel",
                  "whale_watching", "orcas", "whales"), as.numeric))%>%
  ##This code will remove the dates of the flights that had fog
  filter(!Date %in% c("2023-06-23", "2023-07-16", "2023-07-31", "2023-08-06", "2023-08-28",
                      "2023-08-29", "2023-09-09", "2023-09-15"))%>%
  #Selecting only the rows where recreational boats were fishing
  filter(rec_boats_fishing != 0)%>%
  #selecting all of the columns that are needed for further analysis
    select(c(UniqueID, `Filename/FlightID`, Year, Month, Day, Date, `Critical Period`, `Day Type`, `Creel Subarea`, GMA, PFMA, 
           `Pin ID`, Longitude, Latitude, rec_boats_fishing, rec_boats_running))

#Subsetting the dataframe to have points from only the region of interest
rec_boats_fishing2023_subset <- subset(rec_boats_fishing2023, Latitude >= 48.76511688 & Latitude <= 49.00508194 & 
                                  Longitude >= -125.4114807 & Longitude <= -124.987017)
```


#### Loading in the 2022 data

```{r Loading in the 2022 DFO data}
DFO_data_raw_2022 <- read_csv(here("./01_raw_data/DFO_data/Overflight2022_ObservationPoints_20240124_COUNTS.csv"))

#dfo_factors <- c("Day Type", "Creel Subarea")

rec_boats_fishing2022 <- DFO_data_raw_2022%>%
  mutate_at(dfo_factors, factor)%>%
  rename(rec_boats_fishing = `1. Rec Boat Fishing`,
         rec_boats_running = `2. Rec Boats Running`,
         comm_vessel_fishing = `3. Commercial Vessel Fishing`,
         comm_vessel_not_fishing = `4. Commercial Vessel Not Fishing`,
         small_comm_vessel = `5. Small Commercial Vessel`,
         large_comm_vessel = `6. Large Commercial Vessel`,
         whale_watching = `7.  Whale Watching Boat`,
         orcas = `8. Orcas`,
         whales = `9. Whales`,
         sea_state = `10. Sea State`)%>%
  mutate(across(c("rec_boats_fishing", "rec_boats_running", "comm_vessel_fishing", 
                  "comm_vessel_not_fishing", "small_comm_vessel", "large_comm_vessel",
                  "whale_watching", "orcas", "whales"), ~ ifelse(. == "<Null>", 0, .)),
         across(c("rec_boats_fishing", "rec_boats_running", "comm_vessel_fishing", 
                  "comm_vessel_not_fishing", "small_comm_vessel", "large_comm_vessel",
                  "whale_watching", "orcas", "whales"), as.numeric))%>%
   ##This code will remove the dates of the flights that had fog
  filter(!Date %in% c("2022-06-18", "2022-07-31", "2022-08-24", "2022-06-04"))%>%
    filter(rec_boats_fishing != 0)%>%
  #selecting all of the columns that are needed for further analysis
    select(c(UniqueID, `Filename/FlightID`, Year, Month, Day, Date, `Critical Period`, `Day Type`, `Creel Subarea`, GMA, PFMA, 
           `Pin ID`, Longitude, Latitude, rec_boats_fishing, rec_boats_running))

#Subsetting the dataframe to have points from only the region of interest
rec_boats_fishing2022_subset <- subset(rec_boats_fishing2022, Latitude >= 48.76511688 & Latitude <= 49.00508194 & 
                                  Longitude >= -125.4114807 & Longitude <= -124.987017)
```


#### Loading in the 2021 data

```{r Loading in the 2021 DFO data}
DFO_data_raw_2021 <- read_csv(here("./01_raw_data/DFO_data/Overflight2021_ObservationPoints_20240321_counts.csv"))

#dfo_factors <- c("Day Type", "Creel Subarea")

rec_boats_fishing2021 <- DFO_data_raw_2021%>%
  mutate_at(dfo_factors, factor)%>%
  rename(rec_boats_fishing = `1. Rec Boat Fishing`,
         rec_boats_running = `2. Rec Boats Running`,
         comm_vessel_fishing = `3. Commercial Vessel Fishing`,
         comm_vessel_not_fishing = `4. Commercial Vessel Not Fishing`,
         small_comm_vessel = `5. Small Commercial Vessel`,
         large_comm_vessel = `6. Large Commercial Vessel`,
         whale_watching = `7.  Whale Watching Boat`,
         orcas = `8. Orcas`,
         whales = `9. Whales`,
         sea_state = `10. Sea State`)%>%
  mutate(across(c("rec_boats_fishing", "rec_boats_running", "comm_vessel_fishing", 
                  "comm_vessel_not_fishing", "small_comm_vessel", "large_comm_vessel",
                  "whale_watching", "orcas", "whales"), ~ ifelse(. == "<Null>", 0, .)),
         across(c("rec_boats_fishing", "rec_boats_running", "comm_vessel_fishing", 
                  "comm_vessel_not_fishing", "small_comm_vessel", "large_comm_vessel",
                  "whale_watching", "orcas", "whales"), as.numeric))%>%
   ##This code will remove the dates of the flights that had fog
  filter(!Date %in% c("2021-07-31", "2021-07-19", "2021-07-20", "2021-07-24"))%>%
   filter(rec_boats_fishing != 0)%>%
  select(c(UniqueID, `Filename/FlightID`, Year, Month, Day, Date, `Critical Period`, `Day Type`, `Creel Subarea`, GMA, PFMA, 
           `Pin ID`, Longitude, Latitude, rec_boats_fishing, rec_boats_running))

#Subsetting the dataframe to have points from only the region of interest
rec_boats_fishing2021_subset <- subset(rec_boats_fishing2021, Latitude >= 48.76511688 & Latitude <= 49.00508194 & 
                                  Longitude >= -125.4114807 & Longitude <= -124.987017)
```


#### Combining the three years of data into one data frame
```{r Combining the three years of data by row}
rec_boats_fishing_total <- rbind(rec_boats_fishing2021_subset, rec_boats_fishing2022_subset, rec_boats_fishing2023_subset)
```

### Adding the recreational fishing boat data to the data frame

To add the recreational fishin boat data we first calculated the mean number of
recreational fishing boats fishing within various radii of each RLS site. We did
this by making circular polygons around each RLS site and then merging those 
with the rec boat points and counting how many were in each circle each year, 
and then averaging across the three years of data.

#### Calculating the mean recreational boats fishing within each radius

```{r Creating a circular radius around each site}
#Taking the site locations from the clean data frame
site_locations <- st_as_sf(overall_rls_data_groups, coords = c("longitude", "latitude"), crs = 4326)

#removing unnecessary rows
site_locations <- site_locations%>%
  select(c(site_code, site_name, geometry))

#Picking only the unique site locations as some sites have multiple transects
#with the same coordinates
site_locations_u <- site_locations%>%
  distinct(site_code, geometry)

#Changing the projection to handle meter distances better
site_locations_u_proj_m <- st_transform(site_locations_u, crs = 3857)
#Making circles with the different radii around each site
site_locations_radius_1km <- st_buffer(x = site_locations_u_proj_m, dist = 1000)
site_locations_radius_1.5km <- st_buffer(x = site_locations_u_proj_m, dist = 1500)
site_locations_radius_2km <- st_buffer(x = site_locations_u_proj_m, dist = 2000)
```

```{r Finding the overlapping points for each site}
#making a data frame with the coordinates of all the recreational fishing boats
rec_boats_fishing_total_points <- st_as_sf(rec_boats_fishing_total, coords = c("Longitude", "Latitude"), crs = 4326)
#Converting the CRS so it matches the other parts being used
rec_boats_fishing_total_points <- st_transform(rec_boats_fishing_total_points, crs = 3857)


#Finding the fishing boats that are within the given radius and making a new df
#with this info
rec_fishing_boat_total_radius_1km <- st_intersection(site_locations_radius_1km, rec_boats_fishing_total_points)

rec_fishing_boat_total_radius_1.5km <- st_intersection(site_locations_radius_1.5km, rec_boats_fishing_total_points)

rec_fishing_boat_total_radius_2km <- st_intersection(site_locations_radius_2km, rec_boats_fishing_total_points)
```

```{r Making dataframes with boat counts summed for each year at each site}
#Here I took the data frames with the counts and points of boats within the
#radii of the sites and I summed the number of boats counted around a site
#within each year. For example, I added all of the boats around Eagle bay in
#2021

rec_fishing_boat_total_radius_1km_summed <- rec_fishing_boat_total_radius_1km%>%
  #Grouping by each site in each year
  group_by(site_code, Year)%>%
  #adding up the number of boats around a site in each year
  summarise(yearly_rec_boats_fishing = sum(rec_boats_fishing))

rec_fishing_boat_total_radius_1.5km_summed <- rec_fishing_boat_total_radius_1.5km%>%
  group_by(site_code, Year)%>%
  summarise(yearly_rec_boats_fishing = sum(rec_boats_fishing))

rec_fishing_boat_total_radius_2km_summed <- rec_fishing_boat_total_radius_2km%>%
  group_by(site_code, Year)%>%
  summarise(yearly_rec_boats_fishing = sum(rec_boats_fishing))
```

```{r Making a total dataframe for each so that years with no boats have a 0 counts}
#For some sites that had boats counted in one particular year at a given radius
#did not have counts in all years. This step made data frames with a list of all
#of the sites that had at least some counts at the given radius in one of the 
#years and then made a row for each of the three years for that site.

#Makes a row for all three years for sites that had a least one boat counted
#in one of the years
all_sites_years_1km <- expand.grid(
  site_code = unique(rec_fishing_boat_total_radius_1km$site_code),
  Year = unique(rec_fishing_boat_total_radius_1km$Year))

all_sites_years_1.5km <- expand.grid(
  site_code = unique(rec_fishing_boat_total_radius_1.5km$site_code),
  Year = unique(rec_fishing_boat_total_radius_1.5km$Year))

all_sites_years_2km <- expand.grid(
  site_code = unique(rec_fishing_boat_total_radius_2km$site_code),
  Year = unique(rec_fishing_boat_total_radius_2km$Year))
```

```{r Merging the all years df with the rec boat count sums}
#This step merged the summed boat counts at each site with the dataframe that
# had all three years listed so that there was a row with 0 for the sites which
#did not have any counts in a particular year. This was necessary for making the
#average calculation accurate.

rec_fishing_boat_total_radius_1km_complete <- all_sites_years_1km %>%
  #Joins the rec fishing boat counts within radius to the df with all the years
  #for each site by site and year
  left_join(rec_fishing_boat_total_radius_1km_summed, by = c("site_code", "Year")) %>%
  #replaces the rows that have NAs with 0
  mutate(yearly_rec_boats_fishing = replace_na(yearly_rec_boats_fishing, 0))

rec_fishing_boat_total_radius_1.5km_complete <- all_sites_years_1.5km %>%
  left_join(rec_fishing_boat_total_radius_1.5km_summed, by = c("site_code", "Year")) %>%
  mutate(yearly_rec_boats_fishing = replace_na(yearly_rec_boats_fishing, 0))

rec_fishing_boat_total_radius_2km_complete <- all_sites_years_2km %>%
  left_join(rec_fishing_boat_total_radius_2km_summed, by = c("site_code", "Year")) %>%
  mutate(yearly_rec_boats_fishing = replace_na(yearly_rec_boats_fishing, 0))
```

```{r Making the final dataframe with the average boat counts per year for each site}
#This was the final step to average the recreational boat counts at each site 
#across the three years of data


rec_fishing_boat_total_radius_1km_final <- rec_fishing_boat_total_radius_1km_complete%>%
  #groups by each site
  group_by(site_code)%>%
  #makes a new column with the mean number of boats counted within each sites 
  #radius
  summarise(mean_rec_boat_counts_1km = mean(yearly_rec_boats_fishing))

rec_fishing_boat_total_radius_1.5km_final <- rec_fishing_boat_total_radius_1.5km_complete%>%
  group_by(site_code)%>%
  summarise(mean_rec_boat_counts_1.5km = mean(yearly_rec_boats_fishing))

rec_fishing_boat_total_radius_2km_final <- rec_fishing_boat_total_radius_2km_complete%>%
  group_by(site_code)%>%
  summarise(mean_rec_boat_counts_2km = mean(yearly_rec_boats_fishing))
```

```{r Adding the avg counts to the main dataset}
#This step added each of the data frames with the average rec boat counts
# to the modelling dataset. The resulting dataset has a column for avg 
#rec boat counts for each radius distance
overall_rls_data_final <- overall_rls_data_groups%>%
 left_join(rec_fishing_boat_total_radius_1km_final, by = c("site_code"))%>%
 left_join(rec_fishing_boat_total_radius_1.5km_final, by = c("site_code"))%>%
  left_join(rec_fishing_boat_total_radius_2km_final, by = c("site_code"))%>%
  replace(is.na(.), 0)
```


# Making some plots


## Making site maps

### Making the map ranges

```{r Seting the ranges for the maps}
#In this chunk I made limits for the maps so that they show the view of 
#Barkley Sound that I want
lat_min = min(overall_rls_data_final$latitude) - 0.05
lat_max = max(overall_rls_data_final$latitude) + 0.05

long_min = min(overall_rls_data_final$longitude) - 0.05
long_max = max(overall_rls_data_final$longitude) + 0.05
```

### Loading in the low res shape file

```{r Loading in the base layer}
#I loaded in a lower res shape file that shows all of BC in order to make a
#large inset plot of Vancouver Island. Similar to the high res shape file I 
#subsetted it to only include the area around Vancouver Island.

#VI_base_layer <- read_sf(dsn = here("./01_raw_data/canada_sf_data", ""), 
                  #       stringsAsFactors = F)
#VI_base_layer_sf <- st_as_sf(VI_base_layer)

#specifying the projection for the sf
#st_crs(VI_base_layer_sf) <- "+proj=longlat +datum=WGS84 +no_defs"


#shp_xmin_low <- -129
#shp_xmax_low <- -122.5
#shp_ymin_low <- 48
#shp_ymax_low <- 52

#bbox_low <- st_bbox(c(xmin = shp_xmin_low, ymin = shp_ymin_low, xmax = shp_xmax_low, ymax = shp_ymax_low))

#bbox_low_sf <- st_as_sfc(bbox_low)

#VI_base_layer_sf_subset <- st_crop(VI_base_layer_sf, bbox_low_sf)
#plot(VI_base_layer_sf_subset)
```

```{r Loading in the shapefiles to do the fetch calculations, include=FALSE}
#This is a high resolution shape file from Hakai. This code loads in the shape
#file and saves it as the proper shape file object
VI_base_layer_hi_res <- read_sf(dsn = here("./01_raw_data/hakai_zip"),
                                stringsAsFactors = F)

VI_base_layer_hi_res_sf <- st_as_sf(VI_base_layer_hi_res)

#specifying the projection to use for the sf
st_crs(VI_base_layer_hi_res_sf) <- "+proj=longlat +datum=WGS84 +no_defs"



#This subsets the shape file to only be of Barkley Sound to make plotting more
#efficient

#This makes coordinate limits to subset the shapefile
shp_xmin <- -125.4
shp_xmax <- -124.95
shp_ymin <- 48.7
shp_ymax <- 49.0

#This makes a bounding of the coordinates that I just made
bbox <- st_bbox(c(xmin = shp_xmin, ymin = shp_ymin, xmax = shp_xmax, ymax = shp_ymax))

#This converts the boundary box to an SFC object
bbox_sf <- st_as_sfc(bbox)

#This crops the shape file to the area of the bounding box
VI_base_layer_hi_res_sf_subset <- st_crop(VI_base_layer_hi_res_sf, bbox_sf)
#plot(VI_base_layer_hi_res_sf_subset)
```

### Loading in the shapefiles for the protected areas

In order to show the protected areas within Barkley Sound I used Google Earth to make kml files with polygons of the protected areas.

```{r loading in the RCA polygon}
#st_read loads in the kml file and stores it as a polygon
broken_group_RCA <- st_read(here("./01_raw_data/Broken_group_RCA.kml"))
```

```{r Loading in the Numukamis area}
numukamis_area <- st_read(here("./01_raw_data/Numukamis_closed_area.kml"))
```

```{r Loading in the Baeria rocks}
baeria_rocks_er <- st_read(here("./01_raw_data/baeria_rocks.kml"))
```


```{r Loading in the Folger Passage RCA}
folger_pass_RCA <- st_read(here("./01_raw_data/folger_passage_RCA.kml"))
```

### Loading in the flight track for the DFO surveys

I also traced the DFO flight path used for the DFO flyover surveys in Barkley Sound using Google Earth and saved it as a kml file.

```{r Loading in the DFO flight track for Barkley Sound}
#This loads in the flight path so that it can be put on the plot.
dfo_flight_track <- st_read(here("./01_raw_data/dfo_new_flight_path.kml"))
```


###Shifting a couple of the sites to make it clearer

In order to not have a bunch of the sites overlapping each other when plotting maps I shifted some of the points slightly.

```{r Shifting some sites}
overall_rls_data_final_minor_shifted <- overall_rls_data_final%>%
  #These lines of code change the lat or long of the specified site to the given value
 mutate(longitude = if_else(site_code == "BMSC11", -125.153, longitude))%>%
  mutate(latitude = if_else(site_code == "BMSC5", 48.82333, latitude))%>%
  mutate(latitude = if_else(site_code == "BMSC9", 48.83179, latitude))%>%
  mutate(longitude = if_else(site_code == "BMSC9", -125.1490, longitude))%>%
  mutate(longitude = if_else(site_code == "BMSC7", -125.16, longitude))
```


## Figure 1: Overall site map

```{r Making the inset map}
#This makes a map of Vancouver Island
(van_isl_map <- ggplot(VI_base_layer_sf_subset) +
   #allows visualization of sf objects
  geom_sf() +
   #Sets limits for the plot
  coord_sf(ylim = c(48.3, 50.8), xlim = c(-128.2, -123.2)) +
  theme.figure() +
   #Makes a red rectangle around Barkley Sound
  geom_rect(xmin = long_min, xmax = long_max, ymin = lat_min, ymax = lat_max,
            color = "red", fill = NA, linewidth = 1) +
  labs(x = "Longitude", y = "Latitude")+
   theme(axis.text = element_blank(),
         axis.title = element_blank(),
         axis.ticks = element_blank()))
```


```{r Overall site map with the site locations}
(overall_site_map <- ggplot()+
    geom_sf(data = VI_base_layer_hi_res_sf_subset, colour = "darkgrey", fill = "lightgrey")+
   #The lines below plot the polygons of the different protected areas within
   #the sound
   geom_sf(data = broken_group_RCA, fill = "blue", colour ="blue", alpha = 0.1)+
   geom_sf(data = numukamis_area, fill = "blue", colour = "blue", alpha = 0.2)+
   geom_sf(data = baeria_rocks_er, fill = "blue", colour = "blue", alpha = 0.2)+
   geom_sf(data = folger_pass_RCA, fill = "blue", colour = "blue", alpha = 0.2)+
   #This adds in the points of the survey sites, shifted slightly to be not 
   #overlapping
     geom_point(overall_rls_data_final_minor_shifted, 
              mapping = aes(x = longitude, y = latitude, fill = protection_status,
                            shape = region), size = 3,
              colour = "black")+
   #This specifies the different shapes to be used to differentiate
   #between the different regions
   scale_fill_manual(values = c("protected" = "black", "unprotected"=  "white"))+
   scale_shape_manual(values = c(24, 21, 22, 23))+
   #Specifies the colours for unprotected and protected sites
  # scale_fill_manual(values = c("black", "white"))+
       coord_sf(xlim = c(long_min + 0.03, long_max - 0.035),
           ylim = c(lat_min + 0.01, lat_max - 0.04))+
  labs(x = "Longitude", y = "Latitude", shape = "Region",
       fill = "Protection\nStatus") +
  theme.figure() +
  scale_x_continuous(breaks = c(-125.35, -125.20, -125.05)) +
 # scale_y_continuous(breaks = c(48.80, 48.85, 48.90, 48.95, 49.00))+
  #Adds in an arrow indicating north
   annotation_north_arrow(
    location = "tr",
    which_north = "true",
    style = north_arrow_fancy_orienteering
  ) +
   #adds in a scale bar
  annotation_scale(location = "br", text_cex = 1.3)+
   guides(
  fill = guide_legend(override.aes = list(shape = 21)),
  shape = guide_legend(override.aes = list(fill = "white"))
)+
    theme(legend.position = "inside",
      legend.position.inside = c(0.84, 0.2),
         axis.text.y = element_text(angle = 45),
      legend.text = element_text(size = 12),
      legend.title = element_text(size = 14),
      legend.margin = margin(0.3, 0.3, 0.3, 0.3)))
```


```{r Making the site map with the van isl inset, fig.cap= Figure 1. Locations of Reef Life Survey study sites (n = 26) within Barkley Sound, BC, Canada, which were sampled in April and May of 2024. The colours indicate the protection-from-fishing status of each site. Some sites have been shifted slightly to prevent overlap. Region classifications are indicated by the shapes with the region codes corresponding to: BG = Broken Group, DIEC = Deep Imperial Eagle Channel, DGB = Deer Group/Bamfield, and NMB = Numukamis Bay. Areas protected from fishing are shown with blue shade: farthest west = Broken Group Rockfish Conservation Area, central north = Baeria Rocks Ecological Reserve, farthest east = Numukamis Bay Finfish Closure Area. Inset is a map of Vancouver Island illustrating the location of Barkley Sound (red square).}
(site_map_w_inset <- ggdraw(overall_site_map) +
  draw_plot(van_isl_map, x = 0.1, y = 0.15, width = 0.5, height = 0.3))
```

This was the rough version of the plot and then I saved it as a pdf and used inkscape to fine tune the locations of the legends and inset.

```{r Saving the site map}
ggsave("site_map_with_inset_regions.pdf", plot = site_map_w_inset,
       path = here("./04_plots/manuscript_figures"),
       width = 165, height = 130, units = "mm")
```

## Figure N: DFO Boating impacts

In order to visualize how impacted each RLS site in Barkley Sound is by recreational fishing boats I am making a map of the sound with the impacts of each site represented by colour and size of point.

I will try making this plot with both mean number of fishing boats and median number of fishing boats. This first one is for the mean number of boats. Because there are 3 different distances that we have used I will also need to make 3 plots for each value. Then I will try with an averaged value across the three distances if that makes sense to do.

```{r Plot of the impacts of recreational fishing boats around RLS sites 1km}
#This sets the size breaks for the legend of the plot
size_breaks_1km <- c(0, 30, 60, 100)

(rec_boat_impacts_1km_mean <- ggplot()+
   geom_sf(data = VI_base_layer_hi_res_sf_subset, colour = "darkgrey", 
           fill = "lightgrey")+
   #this plots the RLS sites
    geom_point(overall_rls_data_final_minor_shifted, 
              mapping = aes(x = longitude, y = latitude, 
                            size = mean_rec_boat_counts_1km, 
                            fill = protection_status),
                            shape = 21)+
#This is used to adjust the size of the points to be scaled based on the values
    #in the mean rec boat column
     scale_size_continuous(
    range = c(2, 7),
    breaks = size_breaks_1km,
    #this sets the limits so that the scales can be the same overall between 
    #all of the different plots
    limits = c(0, 160),
    #This code adds the labels from the size breaks object
    labels = size_breaks_1km,
      name = "Mean # of Rec Boats\nFishing (1 km)")+
 scale_fill_manual(values = c("black", "white"))+
    coord_sf(xlim = c(long_min + 0.02, long_max - 0.035),
           ylim = c(lat_min + 0.01, lat_max - 0.03)) +
  labs(x = "Longitude", y = "Latitude", fill = "Protection\nStatus") +
  theme.figure() +
   theme(axis.text.y = element_text(angle = 45))+
 scale_x_continuous(breaks = c(-125.35, -125.20, -125.05)) +
  annotation_north_arrow(
   location = "tr",
    which_north = "true",
    style = north_arrow_fancy_orienteering
  )+
  annotation_scale(location = "br", text_cex = 1.3))
```

```{r Saving the rec boat impacts figure 1km map}
ggsave("rec_boat_impacts_1km_mean.pdf", plot = rec_boat_impacts_1km_mean,
       path = here("./04_plots/manuscript_figures"),
       width = 165, height = 130, units = "mm")
```

```{r Plot of the impacts of recreational fishing boats around RLS sites 1.5km}
size_breaks_1.5km <- c(0, 30, 60, 100)

(rec_boat_impacts_1.5km_mean <- ggplot()+
   geom_sf(data = VI_base_layer_hi_res_sf_subset, colour = "darkgrey", 
           fill = "lightgrey")+
   #this plots the RLS sites
    geom_point(overall_rls_data_final_minor_shifted, 
              mapping = aes(x = longitude, y = latitude, 
                            size = mean_rec_boat_counts_1.5km, 
                            fill = protection_status), shape = 21)+
     scale_size_continuous(
    range = c(2, 7),
    breaks = size_breaks_1.5km,
    limits = c(0, 160),
    labels = size_breaks_1.5km,
      name = "Mean # of Rec Boats\nFishing (1.5 km)")+
 scale_fill_manual(values = c("black", "white"))+
    coord_sf(xlim = c(long_min + 0.02, long_max - 0.035),
           ylim = c(lat_min + 0.01, lat_max - 0.03)) +
  labs(x = "Longitude", y = "Latitude", fill = "Protection\nStatus") +
  theme.figure() +
   theme(axis.text.y = element_text(angle = 45))+
 scale_x_continuous(breaks = c(-125.35, -125.20, -125.05)) +
  annotation_north_arrow(
   location = "tr",
    which_north = "true",
    style = north_arrow_fancy_orienteering
  )+
  annotation_scale(location = "br", text_cex = 1.3)+
     theme(legend.position = "inside",
      legend.position.inside = c(0.84, 0.2),
         axis.text.y = element_text(angle = 45),
      legend.text = element_text(size = 12),
      legend.title = element_text(size = 14),
      legend.margin = margin(0.3, 0.3, 0.3, 0.3)))
```

```{r Saving the rec boat impacts figure 1.5km map}
ggsave("rec_boat_impacts_1.5km_mean.pdf", plot = rec_boat_impacts_1.5km_mean,
       path = here("./04_plots/manuscript_figures"),
       width = 165, height = 130, units = "mm")
```


Here is an alternate way of representing the number of rec boats fishing with colours instead

```{r Plot of the impacts of recreational fishing boats around RLS sites 1.5km with colours}
size_breaks_1.5km <- c(0, 30, 60, 100)

(rec_boat_impacts_1.5km_mean_colour <- ggplot()+
   geom_sf(data = VI_base_layer_hi_res_sf_subset, colour = "darkgrey", 
           fill = "lightgrey")+
   #this plots the RLS sites
    geom_point(overall_rls_data_final_minor_shifted, 
              mapping = aes(x = longitude, y = latitude, 
                            fill = mean_rec_boat_counts_1.5km, 
                            shape = protection_status),
              size = 3)+
 scale_fill_gradient(low = "blue",
                     high = "red")+
   scale_shape_manual(values = c(24, 21))+
    coord_sf(xlim = c(long_min + 0.02, long_max - 0.035),
           ylim = c(lat_min + 0.01, lat_max - 0.03)) +
  labs(x = "Longitude", y = "Latitude", shape = "Protection\nStatus",
       fill = "Mean # of Rec Boats\nFishing (1.5 km)") +
  theme.figure() +
   theme(axis.text.y = element_text(angle = 45))+
 scale_x_continuous(breaks = c(-125.35, -125.20, -125.05)) +
  annotation_north_arrow(
   location = "tr",
    which_north = "true",
    style = north_arrow_fancy_orienteering
  )+
  annotation_scale(location = "br", text_cex = 1.3))
```


This is a lot less clear of a way to show the data so I will likely stick with the different sized circles.

```{r Saving the rec boat impacts figure 1.5km map}
ggsave("rec_boat_impacts_1.5km_mean_colour.pdf", plot = rec_boat_impacts_1.5km_mean_colour,
       path = here("./04_plots/manuscript_figures"),
       width = 165, height = 130, units = "mm")
```


```{r Plot of the impacts of recreational fishing boats around RLS sites 2km}
size_breaks_2km <- c(0, 30, 60, 100)

(rec_boat_impacts_2km_mean <- ggplot()+
   geom_sf(data = VI_base_layer_hi_res_sf_subset, colour = "darkgrey", 
           fill = "lightgrey")+
   #this plots the RLS sites
    geom_point(overall_rls_data_final_minor_shifted, 
              mapping = aes(x = longitude, y = latitude, 
                            size = mean_rec_boat_counts_2km, 
                            fill = protection_status), shape = 21)+
     scale_size_continuous(
    range = c(2, 7),
    breaks = size_breaks_2km,
    limits = c(0, 160),
    labels = size_breaks_2km,
      name = "Mean # of Rec Boats\nFishing (2 km)")+
 scale_fill_manual(values = c("#1CB8BC", "#F46864"))+
    coord_sf(xlim = c(long_min + 0.02, long_max - 0.035),
           ylim = c(lat_min + 0.01, lat_max - 0.03)) +
  labs(x = "Longitude", y = "Latitude", fill = "Protection\nStatus") +
  theme.figure() +
   theme(axis.text.y = element_text(angle = 45))+
 scale_x_continuous(breaks = c(-125.35, -125.20, -125.05)) +
  annotation_north_arrow(
   location = "tr",
    which_north = "true",
    style = north_arrow_fancy_orienteering
  )+
  annotation_scale(location = "br", text_cex = 1.3))
```

```{r Saving the rec boat impacts figure 2km map}
ggsave("rec_boat_impacts_2km_mean.pdf", plot = rec_boat_impacts_2km_mean,
       path = here("./04_plots/manuscript_figures"),
       width = 165, height = 130, units = "mm")
```

# Appendix stuff

## DFO Flight path and methods for counting the boats

For this plot we used 2023 and 1.5 km radii as examples of the data we saw for the rec boat counts

```{r total rec boats within 1.5 km, fig.cap=Figure 3. Example of the raw data from DFO flyover surveys (June 1September 30, 2023) indicating the locations of recreational boats fishing (black dots) with 1.5 km radii (red-filled circles) around each Reef Life Survey site (open black dots) in Barkley Sound, BC, Canada. Subtidal surveys were conducted at each site in April and May of 2024. The DFO surveys sometimes grouped boats that were close together as one point, so some points indicate multiple boats, but this has been omitted for ease of viewing. The flight path taken by DFO surveyors is shown (dashed blue line) with arrows showing the direction of flight. DFO surveys were completed in the summers of 2021-23. The mean numbers of recreational boats fishing within 1.0, 1.5, and 2.0 km radii per year were calculated to compare fishing activity between protected and unprotected sites.}
(total_rec_boats_map_2023_test <- ggplot()+
    geom_sf(data = VI_base_layer_hi_res_sf_subset, colour = "darkgrey", fill = "lightgrey")+
   #This plots the DFO plane flight path
   geom_sf(data = dfo_flight_track, colour =  "#355173", size = 3)+
  geom_point(data = rec_boats_fishing2023, 
             mapping = aes(x = Longitude, y = Latitude),
             size = 0.8, fill = "#070707")+
   #This plots the 1.5km radii around each RLS site
    geom_sf(data = site_locations_radius_1.5km, fill = "#E95E48", alpha = 0.3)+
   #this plots the RLS sites
    geom_point(overall_rls_data_final, 
              mapping = aes(x = longitude, y = latitude),
              shape = 21, size = 3, colour = "black")+
    coord_sf(xlim = c(long_min + 0.02, long_max - 0.035),
           ylim = c(lat_min + 0.01, lat_max - 0.03)) +
  labs(x = "Longitude", y = "Latitude") +
  theme.figure() +
   theme(axis.text.y = element_text(angle = 45))+
 scale_x_continuous(breaks = c(-125.35, -125.20, -125.05)) +
  annotation_north_arrow(
    location = "tr",
    which_north = "true",
    style = north_arrow_fancy_orienteering
  ) +
  annotation_scale(location = "br", text_cex = 1.3))
```

A legend was added and the flight path line styling was edited using inkscape.

```{r Saving the rec boats plot with dfo flight track}
ggsave("total_rec_boat_map_2023_1.5km_track.pdf", plot = total_rec_boats_map_2023_test,
       path = here("./04_plots/manuscript_figures"), width = 160, height = 120, units = "mm")
```


## Set up for doing spatial analyses on the data

### Adding columns of projected coordinates for the sites

```{r Adding a column of projected locations for the sites}
#changing the data frame to have the coordinates as a geometry type in WGS84
overall_rls_data_final_geo <- st_as_sf(overall_rls_data_final, 
                                       coords = c("longitude", "latitude"),
                                       crs = 4326)
#converting the coordinates to a projection from around Vancouver Island
overall_rls_data_final_proj <- st_transform(overall_rls_data_final_geo, crs = 32610)

#Extracting the projected coordinates
coords_utm <- st_coordinates(overall_rls_data_final_proj)

#adding the projected coordinates to the main data frame
overall_rls_data_final$easting <- coords_utm[,1]
overall_rls_data_final$northing <- coords_utm[,2]

#adding columns with the data in km
overall_rls_data_final$easting_km <- overall_rls_data_final$easting / 1000
overall_rls_data_final$northing_km <- overall_rls_data_final$northing / 1000
```

### Making a mesh of the sites

```{r Creating a mesh of the RLS sites}
mesh_RLS <- make_mesh(overall_rls_data_final, xy_cols = c("easting_km", "northing_km"),
                      cutoff = 1)

plot(mesh_RLS)
```



# Doing some pre-testing of the data to see what interesting trends there are

## Looking at the fish data

### Total fish

#### Total fish abundance

##### By protection

```{r Total fish abundance by protection}
ggplot(overall_rls_data_final, aes(x = protection_status, y = total_fish))+
  geom_boxplot()+
  theme.figure()
```

##### By kelp and kelp pa

```{r Total fish abundance by kelp}
ggplot(overall_rls_data_final, aes(x = kelp, y = total_fish))+
  geom_boxplot()+
  theme.figure()

ggplot(overall_rls_data_final, aes(x = kelp_pa, y = total_fish))+
  geom_boxplot()+
  theme.figure()

ggplot(overall_rls_data_final, aes(x = sqrt(total_urchins), y = sqrt(total_fish)))+
  geom_point()+
  theme.figure()
```

#### Fish Sizes

##### By protection

```{r Looking at fish size by protection}
ggplot(overall_rls_data_expanded, aes(x = size_class, fill = protection_status))+
  geom_bar()+
  theme.figure()

ggplot(overall_rls_data_expanded, aes(x = protection_status, y = size_class))+
  geom_boxplot()+
  theme.figure()

ggplot(overall_rls_data_expanded, aes(x = protection_status, y = size_class))+
  geom_jitter(height = 0)+
  theme.figure()

protected_fish <- overall_rls_data_expanded%>%
  filter(protection_status == "protected")

protected_fish_mean <- mean(protected_fish$size_class)

unprotected_fish <- overall_rls_data_expanded%>%
  filter(protection_status == "unprotected")

unprotected_fish_mean <- mean(unprotected_fish$size_class)
```

##### By kelp and kelp pa

```{r}
ggplot(overall_rls_data_expanded, aes(x = size_class, fill = kelp))+
  geom_bar()+
  theme.figure()

ggplot(overall_rls_data_expanded, aes(x = size_class, fill = kelp_pa))+
  geom_bar()+
  theme.figure()

ggplot(overall_rls_data_expanded, aes(x = kelp, y = size_class))+
  geom_boxplot()+
  theme.figure()

ggplot(overall_rls_data_expanded, aes(x = kelp_pa, y = size_class))+
  geom_boxplot()+
  theme.figure()

ggplot(overall_rls_data_expanded, aes(x = kelp, y = size_class))+
  geom_jitter(height = 0)+
  theme.figure()

ggplot(overall_rls_data_expanded, aes(x = kelp_pa, y = size_class))+
  geom_jitter(height = 0)+
  theme.figure()
```


## Investigating the Gobies and their relationship to invertebrate grazers

### Making plots on their abundance between protection and kelp

#### Protection

```{r}
ggplot(overall_rls_data_final, aes(x = protection_status, y = Rhinogobiops_nicholsii))+
  geom_boxplot()+
  theme.figure()
```

#### Kelp and kelp pa

```{r}
ggplot(overall_rls_data_final, aes(x = kelp, y = Rhinogobiops_nicholsii))+
  geom_boxplot()+
  theme.figure()

ggplot(overall_rls_data_final, aes(x = kelp_pa, y = Rhinogobiops_nicholsii))+
  geom_boxplot()+
  theme.figure()
```

Maybe seeing few gobies with understory because they are tough to spot?

### Seeing if the gobies are correlated with urchins or snails

#### Urchins

*Some really interesting trends going on here*

```{r}
ggplot(overall_rls_data_final, aes(x = Rhinogobiops_nicholsii, y = total_urchins))+
  geom_point()+
  theme.figure()+
  facet_wrap(~kelp_pa)

ggplot(overall_rls_data_final, aes(x = Rhinogobiops_nicholsii, y = Mesocentrotus_franciscanus))+
  geom_point()+
  geom_smooth(method = "lm")+
  theme.figure()

ggplot(overall_rls_data_final, aes(x = Rhinogobiops_nicholsii, y = Strongylocentrotus_purpuratus))+
  geom_point()+
  theme.figure()

ggplot(overall_rls_data_final, aes(x = Rhinogobiops_nicholsii, y = Strongylocentrotus_droebachiensis))+
  geom_point()+
  theme.figure()
```

##### Testing the correlation between urchins and gobies

```{r Testing assumptions of pearsons r}
#Normality
shapiro.test(overall_rls_data_final$Rhinogobiops_nicholsii)
hist(overall_rls_data_final$Rhinogobiops_nicholsii)

#Not normal so cannot use pearsons r. Must use Spearman's instead

cor.test(overall_rls_data_final$Rhinogobiops_nicholsii, overall_rls_data_final$Mesocentrotus_franciscanus,
         method = "spearman")
```
The analysis shows that the red urchins and blackeye gobies are highly correlated. However, they do not appear to be linearly related

#### Snails

```{r}
ggplot(overall_rls_data_final, aes(x = Rhinogobiops_nicholsii, y = Pomaulax_gibberosus))+
  geom_point()+
  theme.figure()
```

##### Testing the correlation of snails and blackeye gobies

```{r Spearmans correlation test on the snails and gobies}
cor.test(overall_rls_data_final$Rhinogobiops_nicholsii, overall_rls_data_final$Pomaulax_gibberosus,
         method = "spearman")
```
No apparent correlation between the snails and the red turban snails.


## Looking at the urchins

The counts are mainly red sea urchins and the other species appear to have quite low abundances

### Protection

```{r Urchin abundance between protection}
ggplot(overall_rls_data_final, aes(x = protection_status, y = total_urchins))+
  geom_boxplot()+
  theme.figure()

ggplot(overall_rls_data_final, aes(x = protection_status, y = Mesocentrotus_franciscanus))+
  geom_boxplot()+
  theme.figure()

ggplot(overall_rls_data_final, aes(x = protection_status, y = Strongylocentrotus_purpuratus))+
  geom_boxplot()+
  theme.figure()

ggplot(overall_rls_data_final, aes(x = protection_status, y = Strongylocentrotus_droebachiensis))+
  geom_boxplot()+
  theme.figure()
```

### Kelp

```{r Urchin abundance between kelp and kelp pa}
ggplot(overall_rls_data_final, aes(x = kelp, y = total_urchins))+
  geom_boxplot()+
  theme.figure()

ggplot(overall_rls_data_final, aes(x = kelp, y = Mesocentrotus_franciscanus))+
  geom_boxplot()+
  theme.figure()

ggplot(overall_rls_data_final, aes(x = kelp, y = Strongylocentrotus_purpuratus))+
  geom_boxplot()+
  theme.figure()

ggplot(overall_rls_data_final, aes(x = kelp, y = Strongylocentrotus_droebachiensis))+
  geom_boxplot()+
  theme.figure()

ggplot(overall_rls_data_final, aes(x = kelp_pa, y = total_urchins))+
  geom_boxplot()+
  theme.figure()

ggplot(overall_rls_data_final, aes(x = kelp_pa, y = Mesocentrotus_franciscanus))+
  geom_boxplot()+
  theme.figure()

ggplot(overall_rls_data_final, aes(x = kelp_pa, y = Strongylocentrotus_purpuratus))+
  geom_boxplot()+
  theme.figure()

ggplot(overall_rls_data_final, aes(x = kelp_pa, y = Strongylocentrotus_droebachiensis))+
  geom_boxplot()+
  theme.figure()
```





## Looking at the red turban snails

### By protection

```{r}
ggplot(overall_rls_data_final, aes(x = protection_status, y = Pomaulax_gibberosus))+
  geom_boxplot()+
  theme.figure()
```

### By kelp and kelp pa

```{r}
ggplot(overall_rls_data_final, aes(x = kelp, y = Pomaulax_gibberosus))+
  geom_boxplot()+
  theme.figure()

ggplot(overall_rls_data_final, aes(x = kelp_pa, y = Pomaulax_gibberosus))+
  geom_boxplot()+
  theme.figure()
```



## Looking at the nudibranchs

### By protection

```{r}
ggplot(overall_rls_data_final, aes(x = protection_status, y = total_nudibranchs))+
  geom_boxplot()+
  theme.figure()
```

### By kelp and kelp pa

```{r}
ggplot(overall_rls_data_final, aes(x = kelp, y = total_nudibranchs))+
  geom_boxplot()+
  theme.figure()

ggplot(overall_rls_data_final, aes(x = kelp_pa, y = total_nudibranchs))+
  geom_boxplot()+
  theme.figure()
```


## Looking at total mesograzers

### By protection

```{r}
ggplot(overall_rls_data_final, aes(x = protection_status, y = total_mesograzers))+
  geom_boxplot()+
  theme.figure()
```

### By kelp and kelp pa

```{r}
ggplot(overall_rls_data_final, aes(x = kelp, y = total_mesograzers))+
  geom_boxplot()+
  theme.figure()

ggplot(overall_rls_data_final, aes(x = kelp_pa, y = total_mesograzers))+
  geom_boxplot()+
  theme.figure()
```

## Looking at total mesograzers without urchins

### By protection

```{r}
ggplot(overall_rls_data_final, aes(x = protection_status, y = mesograzers_w_o_urchins))+
  geom_boxplot()+
  theme.figure()
```

### By kelp and kelp pa

```{r}
ggplot(overall_rls_data_final, aes(x = kelp, y = mesograzers_w_o_urchins))+
  geom_boxplot()+
  theme.figure()

ggplot(overall_rls_data_final, aes(x = kelp, y = mesograzers_w_o_urchins))+
  geom_boxplot()+
  theme.figure()+
  facet_wrap(~protection_status)


ggplot(overall_rls_data_final, aes(x = kelp_pa, y = mesograzers_w_o_urchins))+
  geom_boxplot()+
  theme.figure()

ggplot(overall_rls_data_final, aes(x = kelp_pa, y = mesograzers_w_o_urchins))+
  geom_boxplot()+
  theme.figure()+
  facet_wrap(~protection_status)
```

## Community composition

```{r Community composition with urchins included}
ggplot(overall_rls_data_expanded_with_all_species, aes(x = protection_status, fill = class))+
  geom_bar()+
  theme.figure()

ggplot(overall_rls_data_expanded_with_all_species, aes(x = kelp, fill = class))+
  geom_bar()+
  theme.figure()

ggplot(overall_rls_data_expanded_with_all_species, aes(x = kelp_pa, fill = class))+
  geom_bar()+
  theme.figure()
```

```{r Community composition with urchins excluded}
ggplot(overall_rls_data_expanded_no_urch, aes(x = protection_status, fill = class))+
  geom_bar()+
  theme.figure()

ggplot(overall_rls_data_expanded_no_urch, aes(x = kelp, fill = class))+
  geom_bar()+
  theme.figure()

ggplot(overall_rls_data_expanded_no_urch, aes(x = kelp_pa, fill = class))+
  geom_bar()+
  theme.figure()
```


## Investigating potential relationship between urchins and puget sound king crabs

```{r}
ggplot(overall_rls_data_final, aes(x = Echidnocerus_cibarius, y = Strongylocentrotus_droebachiensis))+
  geom_point()+
  theme.figure()

ggplot(overall_rls_data_final, aes(x = Echidnocerus_cibarius, y = Strongylocentrotus_purpuratus))+
  geom_point()+
  theme.figure()

ggplot(overall_rls_data_final, aes(x = Echidnocerus_cibarius, y = Mesocentrotus_franciscanus))+
  geom_point()+
  theme.figure()

ggplot(overall_rls_data_final, aes(x = Echidnocerus_cibarius, y = total_urchins))+
  geom_point()+
  theme.figure()

ggplot(overall_rls_data_final, aes(x = protection_status, y = Echidnocerus_cibarius))+
  geom_boxplot()+
  theme.figure()
```

```{r Correlation test}
cor.test(overall_rls_data_final$Mesocentrotus_franciscanus, overall_rls_data_final$Echidnocerus_cibarius,
         method = "spearman")
```



## Investigating potential relationship between urchins and pycno

```{r}
ggplot(overall_rls_data_final, aes(x = Pycnopodia_helianthoides, y = total_urchins))+
  geom_point()+
  theme.figure()

ggplot(overall_rls_data_final, aes(x = Pycnopodia_helianthoides, y = Mesocentrotus_franciscanus))+
  geom_point()+
  theme.figure()

ggplot(overall_rls_data_final, aes(x = Pycnopodia_helianthoides, y = Strongylocentrotus_purpuratus))+
  geom_point()+
  theme.figure()

ggplot(overall_rls_data_final, aes(x = Pycnopodia_helianthoides, y = Strongylocentrotus_droebachiensis))+
  geom_point()+
  theme.figure()
```


## Which sites have few mesograzers

```{r}
#This sets the size breaks for the legend of the plot
size_breaks_1km <- c(0, 250, 500, 1000, 1500)

(mesograzer_abundance <- ggplot()+
   geom_sf(data = VI_base_layer_hi_res_sf_subset, colour = "darkgrey", 
           fill = "lightgrey")+
   #this plots the RLS sites
    geom_point(overall_rls_data_final, 
              mapping = aes(x = longitude, y = latitude, 
                           # size =  mesograzers_w_o_urchins, 
                            size = total_mesograzers,
                            fill = protection_status),
                            shape = 21)+
#This is used to adjust the size of the points to be scaled based on the values
    #in the mean rec boat column
     scale_size_continuous(
  #  range = c(2, 7),
    breaks = size_breaks_1km,
    #this sets the limits so that the scales can be the same overall between 
    #all of the different plots
    limits = c(0, 1500),
    #This code adds the labels from the size breaks object
    labels = size_breaks_1km,
      name = "Mesograzer abundance")+
 scale_fill_manual(values = c("black", "white"))+
    coord_sf(xlim = c(long_min + 0.02, long_max - 0.035),
           ylim = c(lat_min + 0.01, lat_max - 0.03)) +
  labs(x = "Longitude", y = "Latitude", fill = "Protection\nStatus") +
  theme.figure() +
   theme(axis.text.y = element_text(angle = 45))+
 scale_x_continuous(breaks = c(-125.35, -125.20, -125.05)) +
  annotation_north_arrow(
   location = "tr",
    which_north = "true",
    style = north_arrow_fancy_orienteering
  )+
  annotation_scale(location = "br", text_cex = 1.3)+
  facet_wrap(~year))
```

```{r}
ggsave("mesograzer_abundance_with_urchins.pdf", plot = mesograzer_abundance,
       path = here("./04_plots/manuscript_figures"),
       width = 300, height = 300, units = "mm")
```

```{r}
#This sets the size breaks for the legend of the plot
size_breaks_1km <- c(0, 250, 500, 1000, 1500)

(mesograzer_abundance_no_urchins <- ggplot()+
   geom_sf(data = VI_base_layer_hi_res_sf_subset, colour = "darkgrey", 
           fill = "lightgrey")+
   #this plots the RLS sites
    geom_point(overall_rls_data_final, 
              mapping = aes(x = longitude, y = latitude, 
                           size =  mesograzers_w_o_urchins, 
                      
                            fill = protection_status),
                            shape = 21)+
#This is used to adjust the size of the points to be scaled based on the values
    #in the mean rec boat column
     scale_size_continuous(
    #range = c(2, 7),
    breaks = size_breaks_1km,
    #this sets the limits so that the scales can be the same overall between 
    #all of the different plots
    limits = c(0, 1500),
    #This code adds the labels from the size breaks object
    labels = size_breaks_1km,
      name = "Mesograzer abundance (no urchins)")+
 scale_fill_manual(values = c("black", "white"))+
    coord_sf(xlim = c(long_min + 0.02, long_max - 0.035),
           ylim = c(lat_min + 0.01, lat_max - 0.03)) +
  labs(x = "Longitude", y = "Latitude", fill = "Protection\nStatus") +
  theme.figure() +
   theme(axis.text.y = element_text(angle = 45))+
 scale_x_continuous(breaks = c(-125.35, -125.20, -125.05)) +
  annotation_north_arrow(
   location = "tr",
    which_north = "true",
    style = north_arrow_fancy_orienteering
  )+
  annotation_scale(location = "br", text_cex = 1.3)+
  facet_wrap(~year))
```

```{r}
ggsave("mesograzer_abundance_no_urchins.pdf", plot = mesograzer_abundance_no_urchins,
       path = here("./04_plots/manuscript_figures"),
       width = 300, height = 300, units = "mm")
```




# Doing further analysis of the DFO boat data

Given that the DFO data is novel and provides exciting opportunities to look at the spatial properties of fishing within Barkley Sound, I will do further analysis of the boat locations, including the number of boats spotted in protected areas compared to the number of boats spotted in total, and a kernel analysis to obtain a heat map of fishing pressure in the sound.

## Number of boats spotted within protected areas relative to total boats spotted

```{r Finding the number of boats spotted within protected areas}
#This line loads in the recreational fishing boat data and converts the lat and
#long to an sf object in the same CRS as the sf objects for the protected areas
rec_boats_fishing_total_points_wgs84 <- st_as_sf(rec_boats_fishing_total, coords = c("Longitude", "Latitude"), crs = 4326)


#These lines return the rec boat observations that are found within the 
#protected area polygons
rec_boats_within_numukamis <- st_intersection(numukamis_area, rec_boats_fishing_total_points_wgs84)

rec_boats_within_broken_group_RCA <- st_intersection(broken_group_RCA, rec_boats_fishing_total_points_wgs84)

rec_boats_within_baeria_rocks_er <- st_intersection(baeria_rocks_er, rec_boats_fishing_total_points_wgs84)

rec_boats_within_folger_pass_RCA <- st_intersection(folger_pass_RCA, rec_boats_fishing_total_points_wgs84)
```

```{r Filtering the Numukamis Bay boats to only include ones fishing there when it is actually closed}
rec_boats_within_numukamis_final <- rec_boats_within_numukamis%>%
  filter((Date >= as.Date("2021-08-01") & Date <= as.Date("2021-09-30")) |
           (Date >= as.Date("2022-08-01") & Date <= as.Date("2022-09-30")) |
           (Date >= as.Date("2023-08-01") & Date <= as.Date("2023-09-30")))
```


```{r Summing the total number of boats in protected areas and outside}
#These lines add up all of the boats spotted within each protected area
total_boats_broken_group_RCA <- sum(rec_boats_within_broken_group_RCA$rec_boats_fishing)
total_boats_baeria_rocks_er <- sum(rec_boats_within_baeria_rocks_er$rec_boats_fishing)
total_boats_numukamis <- sum(rec_boats_within_numukamis_final$rec_boats_fishing)
total_boats_folger_pass_RCA <- sum(rec_boats_within_folger_pass_RCA$rec_boats_fishing)

#This adds up all of the boats for a total number spotted across all protected
#areas
total_boats_in_protected_areas <- total_boats_broken_group_RCA + total_boats_baeria_rocks_er +
  total_boats_numukamis + total_boats_folger_pass_RCA

#This adds up all of the rec boats fishing that were spotted within Barkley 
#Sound
total_boats_spotted_barkley <- sum(rec_boats_fishing_total$rec_boats_fishing)


#This line calculate the percentage of observations found in protected areas
percent_boats_in_protected_areas <- (total_boats_in_protected_areas/total_boats_spotted_barkley) * 100
```


## Further Kernel Analysis of the recreational boat locations

To gain a better understanding of the spatial nature of the fishing pressure in Barkley Sound I am using a Kernel Density Estimation to produce some plots of the fishing pressure as a heatmap.

```{r Converting the rec boat data into a form for doing the KDE}
#Because there are some points in the data frame that correspond to mulitple
#boats observed I will need to uncount the data frame so there is a row for 
#every boat observation
rec_boat_points_for_kde <- rec_boats_fishing_total_points_wgs84%>%
  select(Year, Month, Day, Date, rec_boats_fishing, geometry)%>%
  uncount(rec_boats_fishing)

#Converting the new dataframe back into an sf object so that the KDE function
#will work properly and converting to a projection which is better for KDE
#analysis
rec_boat_points_for_kde <- st_as_sf(rec_boat_points_for_kde, sf_column_name = "geometry")
rec_boat_points_for_kde <- st_transform(rec_boat_points_for_kde, crs = 32610)

#Filtering so there is a df for each year
rec_boat_points_for_kde_21 <- rec_boat_points_for_kde%>%
  filter(Year == 2021)

rec_boat_points_for_kde_22 <- rec_boat_points_for_kde%>%
  filter(Year == 2022)

rec_boat_points_for_kde_23 <- rec_boat_points_for_kde%>%
  filter(Year == 2023)
```


```{r Calculating the KDE for the rec boat data}
#This is the function that computes the KDE for the data
rec_boat_kde_overall <- st_kde(rec_boat_points_for_kde)
rec_boat_kde_21 <- st_kde(rec_boat_points_for_kde_21)
rec_boat_kde_22 <- st_kde(rec_boat_points_for_kde_22)
rec_boat_kde_23 <- st_kde(rec_boat_points_for_kde_23)
```

```{r Converting the other aspects of the map into the same projection as the KDE}
VI_base_layer_hi_res_sf_subset_projected <- st_transform(VI_base_layer_hi_res_sf_subset, crs = 32610)
```


```{r Plotting the overall KDE}
(overall_rec_boat_kde_map <- ggplot(rec_boat_kde_overall)+
   geom_sf(data = VI_base_layer_hi_res_sf_subset_projected, colour = "darkgrey", fill = "lightgrey")+
  geom_sf(data = st_get_contour(rec_boat_kde_overall),aes(fill=label_percent(contlabel)))+
  coord_sf(
    xlim = c(324000, 355000),  # replace with your min/max x
    ylim = c(5406000, 5427000) # replace with your min/max y
  )+
   scale_fill_viridis_d(option = "B", end = 0.5, begin = 1)+
  theme.figure())
```


```{r}
ggsave("overall_rec_boat_KDE.pdf", plot = overall_rec_boat_kde_map,
       path = here("./04_plots/manuscript_figures"), width = 160, height = 120, units = "mm")
```


```{r}
pts <- st_as_sf(
  data.frame(id = 1:50,
             x = rnorm(50, 5000, 1000),
             y = rnorm(50, 5000, 1000)),
  coords = c("x", "y"),
  crs = 32610
)

# kernel density
kde <- st_kde(pts)

# plot
plot(kde)
```


```{r Plotting the KDE}
kde_contour_plot <- ggplot(rec_boat_kde)+
   geom_sf(data = VI_base_layer_hi_res_sf_subset, colour = "darkgrey", fill = "lightgrey")

kde_contour_plot + geom_sf(data = rec_boats_fishing_total_points_wgs84)
```


# Initial modelling

I will be using the sdmTMB package to create models looking at the abundances/densities of urchins, fish, and other invertebrates at the RLS sites within Barkley Sound. The models will be based on the protection status of the survey sites as the predictor variable.

## Urchin Modelling

I will be starting with a model looking at the number of urchins overall at the different sites, and then I will make specific models for each of the three main urchin species. 

I will try with a few different likely distributional families and then see which one fits the data the best.

### Tweedie

```{r Urchin model}
urch_mod <- sdmTMB(total_urchins ~ protection_status,
                   data = overall_rls_data_final,
                   mesh = mesh_RLS,
                   family = tweedie(link = "log"),
                   spatial = "on",
                   spatiotemporal = "off")
urch_mod

sanity(urch_mod)

tidy(urch_mod, conf.int = TRUE)

tidy(urch_mod, "ran_pars", conf.int = TRUE)


predictions<-predict(urch_mod, newdata=overall_rls_data_final)

ggplot(data=predictions, aes(x=easting_km, y = northing_km, colour = omega_s))+
  geom_point()

#visreg::visreg(urch_mod, "protection_status")

summary(urch_mod)
```

```{r Inspecting fit of urchin model}
set.seed(123)
overall_rls_data_final$resids <- simulate(urch_mod, nsim = 100, type = "mle-mvn") |>
  dharma_residuals(urch_mod)
```

```{r Plotting spatial residuals}
ggplot(overall_rls_data_final, aes(x = easting_km, y = northing_km, colour = resids$observed))+
  scale_colour_gradient2()+
  geom_point()+
  facet_wrap(~year)+
  coord_fixed()
```

### Poisson

```{r Urchin model}
urch_mod_poi <- sdmTMB(total_urchins ~ protection_status,
                   data = overall_rls_data_final,
                   mesh = mesh_RLS,
                   time = "year",
                   family = poisson(link = "log"),
                   spatial = "off",
                   spatiotemporal = "off")
urch_mod_poi

sanity(urch_mod_poi)

tidy(urch_mod_poi, conf.int = TRUE)

tidy(urch_mod_poi, "ran_pars", conf.int = TRUE)
```

```{r Inspecting fit of urchin model}
set.seed(123)
overall_rls_data_final$resids_poi <- simulate(urch_mod_poi, nsim = 100, type = "mle-mvn") |>
  dharma_residuals(urch_mod_poi)
```

```{r Plotting spatial residuals}
ggplot(overall_rls_data_final, aes(x = easting_km, y = northing_km, colour = resids_poi$observed))+
  scale_colour_gradient2()+
  geom_point()+
  facet_wrap(~year)+
  coord_fixed()
```
